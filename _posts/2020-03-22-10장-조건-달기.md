# # 왜 조건을 다는가?    
## ## 올바른 전화번호 형식 찾기
```php
$pattern = '/\(?\d{3}\)?-?\d{3}-\d{4}/'
$subject = '123-456-7890
(123)456-7890 
(123)-456-7890
(123-456-7890
1234567890
123 456 7890'
preg_match_all($pattern, $subject, $result)
=> 4
```
```php
$result
=> [
     [
       "123-456-7890",
       "(123)456-7890",
       "(123)-456-7890",
       "(123-456-7890",
     ],
   ]
>>>
```
- `\(?`
    - 여는 괄호가 없거나 하나인 경우
    - 이스케이프 해야 함
- `\d{3}`
    - 처음에 나오는 숫자 3자리
- `\)?`
    - 닫는 괄호가 없거나 하나인 경우
- `-?`
    - 하이픈이 없거나 하나인 경우
- `\d{3}-\d{4}`
    - 하이픈으로 구분된 나머지 일곱 숫자

- 확실히 마지막 두 행과 일치X
- 그러나 올바르지 않은 형식의 세번째(닫는 괄호와 하이픈 모두 있음), 네번째(괄호 짝 맞지 않음) 행과 일치O

# # 조건 사용하기
- 물음표(?) 사용
    - `?` 
        - 바로 앞에 문자나 표현식이 존재한다면, 그 문자 또는 표현식과 일치
    - `?=`, `?<=`
        - 만약 존재한다면 앞(전방탐색), 뒤(후방탐색)의 텍스트와 일치
- 위와 동일한(역참조, 전후방탐색) 조건을 달 수 있음
    
## ##  역참조 조건

### ### 예제: `img` 태그를 일치시키고, `a` 태그로 감싸져 있을 경우 함께 일치
```php
$pattern = '/(<[Aa]\s+[^>]+>\s*)?<[Ii][Mm][Gg]\s+[^>]+>(?(1)\s*<\/[Aa]>)/'
$subject = '<!-- Nav bar -->
<div>
<a href="/home"><img src="/images/home.gif"></a>
<img src="/images/spacer.gif">
<a href="/search"><img src="/images/search.gif"></a>
<img src="/images/spacer.gif">
<a href="/help"><img src="/images/help.gif"></a>
</div>'
preg_match_all($pattern, $subject, $result)
=> 5
```
```php
$result
=> [
     [
       "<a href="/home"><img src="/images/home.gif"></a>",
       "<img src="/images/spacer.gif">",
       "<a href="/search"><img src="/images/search.gif"></a>",
       "<img src="/images/spacer.gif">",
       "<a href="/help"><img src="/images/help.gif"></a>",
     ],
     [
       "<a href="/home">",
       "",
       "<a href="/search">",
       "",
       "<a href="/help">",
     ],
   ]
```
- 이전 하위 표현식이 검색에 성공했을 경우에만 다시 그 표현식 검사
- `(?(역참조)true)`
- `(<[Aa]\s+[^>]+>\s*)?`
  - `<A> 나 <a> 시작 태그가 일치`
  - 속성이 있다면 함께 일치
  - `?`
    - 이 패턴이 없어도 되고, 있다면 일치함
- `<[Ii][Mm][Gg]\s+[^>]+>`
  - `<img>` 대소문자 구별 없이, `<img>` 속성 함께 일치
- `(?(1)\s*<\/[Aa]>)`
  - `?(1)` 역참조 1(`<a> 시작 태그`) 이 있을 때만 수행
  - `<a>` 와 일치한다면 그 종료 태그도 일치
  - (1) 있다면, `\s*<\/[Aa]>` 는 `</a> 종료 태그` 나오기 전까지 모든 문자 일치
- `?(1)`
  - 역참조 1이 있는지 없는지 검사
  - 역참조 번호를 조건에서 이스케이프 할 필요X
  - `?(1)` 맞고, `?(\1)` 잘못된 것, 후자 동작하지 않음
  
### ### 예제: 올바른 전화번호 형식 찾기
```php
$pattern = '/(\()?\d{3}(?(1)\)|-)\d{3}-\d{4}/'
preg_match_all($pattern, $subject, $result)
```
```php
$result
=> [
     [
       "123-456-7890",
       "(123)456-7890",
       "123-456-7890",
     ],
     [
       "",
       "(",
       "",
     ],
   ]
```
- 이전 하위 표현식이 검색에 성공했을 경우와 실패했을 경우 각각 다르게 검사
- `(?(역참조)true|false)`
- `(\()?`
  - 여는 괄호가 있는지 검사하지만, 괄호로 감싸 그 결과를 하위 표현식으로 만듦
- `\d{3}`
  - 숫자 세 개로 이루어진 지역번호와 일치
- `(?(1)\)|-)`
  - 조건 만족하는지에 따라 `)닫는 괄호` 혹은 `-하이픈` 과 일치
  - 만약 `(1)` 이 있다면 (다시 말해 `(여는 괄호` 가 있다면), `)닫는 괄호` 와 일치하고, 없다면 `-하이픈` 과 일치
  - 괄호는 항상 짝을 이뤄야 하고, 지역번호와 숫자를 구분하는 하이픈은 괄호가 없을 때만 일치
  - 네번째 줄이 일치한 이유
    - `(여는 괄호` 와 일치하는 쌍이 없으므로 관련 없는 텍스트로 간주되어 무시되었기 때문

## ## 전후방탐색 조건

### ### 예제: 올바른 우편번호 형식 찾기
#### #### 잘못된 예
```php
$subject = '11111
22222
33333-
44444-4444'
$pattern = '/\d{5}(-\d{4})?/'
preg_match_all($pattern, $subject, $result)
=> 4
```
```php
$result
=> [
     [
       "11111",
       "22222",
       "33333",
       "44444-4444",
     ],
     [
       "",
       "",
       "",
       "-4444",
     ],
   ]
```
- `\d{5}`
    - 첫 다섯 자리 숫자와 일치
- `(-\d{4})?`
    - `-하이픈` 과 네 자리 숫자로 이루어진 문자열과 일치

#### #### 올바른 예
```php
$pattern = '/\d{5}(?(?=-)-\d{4})/'
preg_match_all($pattern, $subject, $result)
```
```php
$result
=> [
     [
       "11111",
       "22222",
       "44444-4444",
     ],
   ]
```
- `\d{5}`
  - 앞부분에 있는 다섯 자리 숫자와 일치
- `(?(?=-)-\d{4})`
  - 전방탐색 `?=-` 사용해서 `-하이픈` 찾아내지만 소비 X
  - `-하이픈` 이 있다는 조건 만족하면 `-\d{4}`